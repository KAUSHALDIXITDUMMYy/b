<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>noVNC - Fliff Bot VNC Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #1a1a1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #noVNC_screen {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        .noVNC_status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: monospace;
            z-index: 1000;
            font-size: 14px;
        }
        .noVNC_status.connected {
            background: rgba(0,255,0,0.8);
            color: black;
        }
        .noVNC_status.error {
            background: rgba(255,0,0,0.8);
        }
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: 1px solid #555;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        .btn:hover {
            background: rgba(0,0,0,0.9);
        }
    </style>
</head>
<body>
    <div class="noVNC_status" id="status">Connecting to VNC...</div>
    <div class="controls">
        <a href="/vnc" class="btn" style="text-decoration: none;">‚Üê Dashboard</a>
        <button class="btn" onclick="location.reload()">üîÑ Refresh</button>
        <button class="btn" onclick="window.close()">‚úï Close</button>
    </div>
    <canvas id="noVNC_screen"></canvas>

    <script type="module">
        // Import noVNC from served files (use absolute paths from /novnc/ root)
        import RFB from '/novnc/core/rfb.js';
        import * as WebUtil from '/novnc/app/webutil.js';

        const statusEl = document.getElementById('status');
        const screen = document.getElementById('noVNC_screen');
        
        // Get VNC port from URL parameter or use default
        const urlParams = new URLSearchParams(window.location.search);
        const vncPort = urlParams.get('port') || '5900';
        const wsPort = urlParams.get('ws') || (parseInt(vncPort) - 5900 + 6081).toString();
        
        // WebSocket URL - connect through websockify proxy
        // websockify runs on port 6080 in container, mapped to 6081 on host
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsHost = window.location.hostname;
        const wsUrl = `${wsProtocol}//${wsHost}:${wsPort}`;
        
        console.log('Connecting to VNC via:', wsUrl);
        statusEl.textContent = `Connecting to ${wsHost}:${wsPort}...`;
        
        try {
            // Create RFB connection
            const rfb = new RFB(screen, wsUrl, {
                credentials: {
                    password: ''
                }
            });

            rfb.addEventListener('connect', () => {
                statusEl.textContent = '‚úÖ Connected to VNC';
                statusEl.className = 'noVNC_status connected';
                console.log('VNC connected successfully');
            });

            rfb.addEventListener('disconnect', (e) => {
                if (e.detail.clean) {
                    statusEl.textContent = 'Disconnected';
                    statusEl.className = 'noVNC_status';
                } else {
                    statusEl.textContent = '‚ùå Connection error: ' + (e.detail.reason || 'Unknown');
                    statusEl.className = 'noVNC_status error';
                    console.error('VNC disconnect:', e.detail);
                }
            });

            rfb.addEventListener('credentialsrequired', () => {
                // No password needed
                rfb.sendCredentials({ password: '' });
            });

            rfb.scaleViewport = true;
            rfb.resizeSession = false;
            
            // Handle errors
            rfb.addEventListener('securityfailure', (e) => {
                statusEl.textContent = 'Security failure: ' + e.detail.reason;
                statusEl.className = 'noVNC_status error';
            });

        } catch (error) {
            statusEl.textContent = '‚ùå Error: ' + error.message;
            statusEl.className = 'noVNC_status error';
            console.error('VNC connection error:', error);
        }
    </script>
</body>
</html>




